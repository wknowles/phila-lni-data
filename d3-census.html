<!DOCTYPE html>
<meta charset="utf-8">

<style>

path {
    fill: #fff;
    stroke: #aaa;
    stroke-width: .75px;
    pointer-events: all;
}

.fill {
      fill: #fff;
      stroke: white;
  }

.text {
  font-family: sans-serif;
  font-size: 24px;
  color: #aaa;
}

.axis text {
    font: 10px sans-serif;
}

.axis line, .axis path {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
}

#key    {
    position: absolute;
    top:150px;
    left: 50px;
}

div.tooltip {
  position: absolute;
  text-align: left;
  width: 150px;
  height: 25px;
  padding: 2px;
  font-size: 10px;
  background: #FFFFE0;
  border: 1px;
  border-radius: 8px;
  pointer-events: none;
}
</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/queue.v1.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<body>
<h1 style="text-align: center;">Number of active rental licenses applied for in 2016 grouped by census tract</h1>

<script>
// set up map
var width = 800,
    height = 500;

var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var projection = d3.geoMercator()
    .center([-75.12, 40.002])
    .scale(80000);

var path = d3.geoPath()
    .projection(projection);


// read map file and data
queue()
  .defer(d3.json, "data/census_tracts.json")
  .defer(d3.csv, ("https://data.phila.gov/resource/st4m-d4h3.csv?"
  + "$select=censustract,count(censustract)"
  + "&$group=censustract"
  + "&$order=censustract"
  + "&$where=issuedate>%272016-01-01T00:00:00.000%27"
  + "&licensestatus=Active"
  + "&revenuecode=3202"
  + "&$$app_token=8nwKL3zJBeBIdPKTZzwuKspfh")) // app_token should be REDACTED but whatevs... security :-(
  .await(ready);

//Start of Choropleth drawing
  function ready(error, map, data) {
   var tractById = {};
   var totalById = {};

   data.forEach(function(d) {
    tractById[+d.censustract] = +d.count_censustract;
    totalById[+d.count_censustract] = +d.censustract;
  });

var minimumColor = "#efedf5", maximumColor = "#756bb1";
var color = d3.scaleLinear()
              .domain(d3.extent(data, function(d) { return +d.count_censustract; }))
              .range([minimumColor, maximumColor]);

console.log(d3.extent(data, function(d) { return +d.count_censustract; }))

//Draw Choropleth
  svg.append("g")
  .attr("class", "map")
  .selectAll("path")
  .data(topojson.feature(map, map.objects.Census_Tracts_2010).features)
  .enter().append("path")
  .attr("d", path)
  .attr("id", function(d) {
    return d.properties.NAME10;
  })
  .style("fill", function(d) {
    return color(tractById[d.properties.NAME10]);
  })
  .style("opacity", 0.8)

//var nodecimal = d3.format('.0f')

    //Adding mouseevents
  .on("mouseover", function(d) {
    d3.select(this).transition().duration(300).style("opacity", 1);
    div.transition().duration(300)
    .style("opacity", 1)
    div.text("Census Tract = " + d.properties.NAME10 + " Total = " + tractById[d.properties.NAME10])
    .style("left", (d3.event.pageX) + "px")
    .style("top", (d3.event.pageY -30) + "px");
    console.log(d.properties.NAME10);
  })
  .on("mouseout", function() {
    d3.select(this)
    .transition().duration(300)
    .style("opacity", 0.8);
    div.transition().duration(300)
    .style("opacity", 0);
  })

console.log(totalById[3])
console.log(tractById[3])
// console.log(JSON.stringify(totalById))

}; // <-- End of Choropleth drawing

  //Adding legend for our Choropleth

  // var legend = svg.selectAll("g.legend")
  // .data(color_domain)
  // .enter().append("g")
  // .attr("class", "legend");

  // var ls_w = 20, ls_h = 20;

  // legend.append("rect")
  // .attr("x", 20)
  // .attr("y", function(d, i){ return height - (i*ls_h) - 2*ls_h;})
  // .attr("width", ls_w)
  // .attr("height", ls_h)
  // .style("fill", function(d, i) { return color(d); })
  // .style("opacity", 0.8);

  // legend.append("text")
  // .attr("x", 50)
  // .attr("y", function(d, i){ return height - (i*ls_h) - ls_h - 4;})
  // .text(function(d, i){ return legend_labels[i]; });


// //import active rentals anc census tracts
// d3.csv("data/active_rental.csv", function(error, data) {
//   if (error) throw error;

//  // nest and rollup data
//   var censusCount = d3.nest()
//     .key(function(d) { return d.census_tract })
//     .rollup(function(d) { return d.length; })
//     .entries(data);

// //console.log(JSON.stringify(censusCount));

// d3.json("data/census_tracts.json", function(error, topology) {
//     svg.selectAll("path")
//         .data(topojson.feature(topology, topology.objects.Census_Tracts_2010).features)
//       .enter().append("path")
//         .attr("class", "tracts")
//   .attr("id", function(d){return d.properties.NAME10;})
//   .attr("d", path)
//   .style("fill", function(d) {return color(d.properties.NAME10); })
//   });

// var minimum = d3.min(censusCount, function(d) { return d.value; }), maximum = d3.max(censusCount, function(d) { return d.value; });
// var minimumColor = "#edf8e9", maximumColor = "#238b45";
// var color = d3.scaleLinear().domain([minimum, maximum]).range([minimumColor, maximumColor]);
//  });

</script>
